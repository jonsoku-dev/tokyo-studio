# 도쿄 지도 통합 기능 명세서

**기능 브랜치**: `020-map-integration`
**작성일**: 2025-12-28
**상태**: 진행 중

## 개요

한국인 신규 정착자를 위한 대화형 도쿄 지도 제공. 주요 기능:
- 구청, 은행, 이민국, 이동통신사, 주택 지역, 편의점 등의 위치 표시
- 영어/일본어/한국어 다국어 지원
- 카테고리별 필터링 및 검색 기능
- 구글 맵 내비게이션 연동
- 즐겨찾기 저장 기능

### US-1: 정착 필수 위치 지도 표시 (P1)

**배경**: 신규 정착자는 구청, 은행, 이민국 등 주요 기관의 위치를 빠르게 파악해야 함.

**수용 기준**:
1. 지도 로드 시 도쿄 중심(시부야/신주쿠)을 기본값으로 표시
2. 마커 클릭 시 영/일/한 다국어 정보(이름, 주소, 전화, 시간, 최근역) 표시
3. 줌아웃 시 마커는 자동으로 클러스터링되어 지도 가독성 유지
4. 마커 클러스터 클릭 시 지도를 해당 영역으로 확대

---

### US-2: 카테고리 필터링 (P1)

**배경**: 50개 이상의 마커를 한 번에 표시하면 사용성 저하. 사용자가 필요한 정보에만 집중할 수 있어야 함.

**수용 기준**:
1. 카테고리(정부, 은행, 이민, 이동통신, 주택, 쇼핑) 필터 제공
2. 복수 선택 가능 (선택한 카테고리의 합집합 표시)
3. 모바일에서는 하단 드로어로 필터 표시
4. 필터 초기화 버튼 제공

---

### US-3: 위치 검색 (P2)

**배경**: 특정 지점(예: "시부야 구청")을 알고 있는 사용자는 검색으로 빠르게 찾을 수 있어야 함.

**수용 기준**:
1. 위치명/주소로 검색 가능 (영/일/한 모두 지원)
2. 검색 결과 클릭 시 지도 중심을 해당 위치로 이동
3. 3자 이상 입력 시 자동완성 제안 제공 (300ms 이내)
4. 검색 결과 없으면 "검색 결과 없음" 메시지 표시

---

### US-4: 길안내 기능 (P2)

**배경**: 사용자의 현재 위치에서 목적지까지의 경로를 빠르게 확인할 수 있어야 함.

**수용 기준**:
1. 마커의 "길안내" 버튼 클릭 시 구글맵으로 이동
2. 현재 위치 권한 미획득 시: 목적지만 미리 입력된 상태로 구글맵 오픈
3. 모바일: 설치된 경우 네이티브 구글맵 앱 실행
4. 주소 텍스트 클릭 시 클립보드로 복사 및 토스트 표시

---

### US-5: 즐겨찾기 및 커스텀 마커 (P3)

**배경**: 자주 방문하는 위치나 발견한 맛집 등을 표시할 수 있으면 편함. (인증 필수)

**수용 기준**:
1. 별 아이콘으로 즐겨찾기 저장/삭제 가능
2. "저장된 위치" 뷰에서 목록 확인 가능
3. 지도 우클릭(또는 롱프레스)으로 커스텀 마커 추가
4. 커스텀 마커는 다른 색상으로 구분 표시

## 기능 요구사항

### P1 (초기 출시)

| 요구사항 | 설명 |
|---------|------|
| **지도 표시** | 도쿄 중심(시부야/신주쿠, 35.6762°N, 139.6503°E)을 기본값으로 하는 대화형 지도 |
| **마커 카테고리** | 정부(파란색), 은행(초록색), 이민(빨간색), 이동통신(보라색), 주택(주황색), 쇼핑(노란색) |
| **다국어 지원** | 각 위치당 영/일/한 이름, 주소, 전화, 시간, 최근역 정보 표시 |
| **필터링** | 카테고리 복수 선택 필터 (실시간 업데이트) |
| **검색** | 위치명/주소 검색 (영/일/한 모두 지원) + 자동완성 |
| **마커 클러스터링** | 줌아웃 시 자동 클러스터링으로 가독성 유지 |
| **길안내** | 구글맵 연동 (위치권한 선택적) |
| **모바일 최적화** | 터치 제스처 지원, 하단 드로어 필터 |

### P2 (2차 개선)

| 요구사항 | 설명 |
|---------|------|
| **즐겨찾기** | 인증된 사용자의 저장 위치 (데이터베이스 연동) |
| **커스텀 마커** | 사용자 추가 마커 저장 |
| **클립보드 복사** | 주소 복사 기능 |

### P3 (향후 고려)

- 도쿄 외 지역(요코하마, 치바, 사이타마) 지원
- 위치 신고 기능 ("최종 업데이트 날짜" + "문제 신고" 버튼)

### 기술 스택

| 항목 | 선택 | 사유 |
|------|------|------|
| **지도 라이브러리** | Google Maps API v3 | 마커 클러스터링, 내비게이션 기본 지원 |
| **상태 관리** | Legend State (앱 기본) | 반응형 UI 업데이트 (필터, 검색) |
| **데이터 소스** | SQLite + Drizzle ORM | 위치 데이터 저장 및 쿼리 |
| **컴포넌트** | React Router v7 (클라이언트 렌더링) | 서버-클라이언트 분리 구현 |

### 설계 원칙

**단방향 데이터 흐름**:
- 사용자 입력 → 상태 업데이트 → UI 반영
- 필터/검색 상태는 Legend State로 중앙화
- 부수 효과(API 호출, 권한 요청)는 최소화

**useEffect 최소화**:
- 지도 초기화: 1회만 실행 (empty dependency)
- 필터/검색: Legend State 구독으로 처리 (effect 제거)
- 마커 업데이트: 상태 변경 시 자동 리렌더 (effect 불필요)

## 데이터 모델

### MapLocation (위치 데이터)
```typescript
{
  id: string
  category: 'government' | 'immigration' | 'banking' | 'mobile' | 'housing' | 'shopping'
  name_en: string
  name_ja: string
  name_ko: string
  address: string
  latitude: number
  longitude: number
  phone?: string
  hours?: string  // "09:00-18:00"
  station?: string  // "최근역 이름"
  updated_at: Date
}
```

### UserFavorite (즐겨찾기)
```typescript
{
  id: string
  user_id: string
  location_id: string
  created_at: Date
}
```

### CustomMarker (커스텀 마커)
```typescript
{
  id: string
  user_id: string
  name: string
  category: string
  latitude: number
  longitude: number
  notes?: string
  created_at: Date
}
```

## 성공 기준

### 성능 목표

| 항목 | 기준 |
|------|------|
| **초기 로딩** | 4G에서 2초, 3G에서 5초 이내 |
| **마커 개수** | 100개 이상 동시 표시 가능 (60 FPS) |
| **검색 응답** | 3자 이상 입력 시 300ms 이내 자동완성 |
| **클러스터링** | 줌아웃 시 가시 마커 70% 이상 감소 |

### UX 검증

| 항목 | 기준 |
|------|------|
| **필터링** | 사용자 80%가 튜토리얼 없이 카테고리 필터 사용 성공 |
| **길안내** | 길안내 버튼 클릭 시 90% 이상 구글맵 정상 이동 |
| **모바일 사용성** | 터치 제스처만으로 핵심 기능 완료 가능 |

### 데이터 품질

- 위치 정보 정확도 90% 이상 (월 1회 검증)
- API 무중단 시간 99% 이상

## 구현 범위

### 포함 (P1)
- [x] 지도 표시 및 기본 마커
- [x] 카테고리 필터링
- [x] 텍스트 검색 + 자동완성
- [x] 구글맵 길안내 연동
- [x] 모바일 최적화

### 미포함 (P2+)
- [ ] 즐겨찾기 (인증 필요, 2차)
- [ ] 커스텀 마커 (인증 필요, 2차)
- [ ] 도쿄 외 지역 (3차)
- [ ] 위치 신고 기능 (3차)

## 위험 요소 및 완화 방안

| 위험 | 완화 방안 |
|------|---------|
| Google Maps API 비용 증가 | Mapbox 폴백 준비, API 쿼리 캐싱 |
| 위치 데이터 오래됨 | 월 1회 정기 검증, 사용자 신고 기능 |
| 모바일 성능 저하 | 마커 가상화, 점진적 로딩 |
| 검색 지연 | 클라이언트 사이드 인덱싱 (즉시 응답) |
